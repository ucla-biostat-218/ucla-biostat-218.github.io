<!DOCTYPE html>
<html lang="en"><head>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-b6e6edf6cb1293d7f667c2f39c143ab5.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.7.32">

  <meta name="author" content="Marc A Suchard @ UCLA">
  <title>Structured query language</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #767676;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #767676;  padding-left: 4px; }
    div.sourceCode
      { color: #545454; background-color: #fefefe; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #545454; } /* Normal */
    code span.al { color: #7928a1; } /* Alert */
    code span.an { color: #696969; } /* Annotation */
    code span.at { color: #a55a00; } /* Attribute */
    code span.bn { color: #7928a1; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #d91e18; } /* ControlFlow */
    code span.ch { color: #008000; } /* Char */
    code span.cn { color: #d91e18; } /* Constant */
    code span.co { color: #696969; } /* Comment */
    code span.cv { color: #696969; font-style: italic; } /* CommentVar */
    code span.do { color: #696969; font-style: italic; } /* Documentation */
    code span.dt { color: #7928a1; } /* DataType */
    code span.dv { color: #7928a1; } /* DecVal */
    code span.er { color: #7928a1; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #a55a00; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #696969; } /* Information */
    code span.kw { color: #d91e18; } /* Keyword */
    code span.op { color: #00769e; } /* Operator */
    code span.ot { color: #d91e18; } /* Other */
    code span.pp { color: #7928a1; } /* Preprocessor */
    code span.sc { color: #00769e; } /* SpecialChar */
    code span.ss { color: #008000; } /* SpecialString */
    code span.st { color: #008000; } /* String */
    code span.va { color: #a55a00; } /* Variable */
    code span.vs { color: #008000; } /* VerbatimString */
    code span.wa { color: #696969; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto-2504e1d4645b0b9d9692619f8847e2f1.css">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Structured query language</h1>
  <p class="subtitle">Biostat 218</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Marc A Suchard @ UCLA 
</div>
</div>
</div>

</section>
<section id="introduction" class="slide level2">
<h2>Introduction</h2>
<p>In this lecture we will learn how to:</p>
<ul>
<li><p>Think about structured queries in databases</p></li>
<li><p>Support many different management systems</p></li>
<li><p>Handle different dialects</p></li>
<li><p>Write simple queries against the OMOP CDM</p></li>
</ul>
</section>
<section id="sql-purpose" class="slide level2">
<h2>SQL purpose</h2>
<ul>
<li><p><strong>Domain-specific language</strong> (DSL) for relational database management systems (RDBMS)</p></li>
<li><p>Specialized to handle <strong>structured data</strong> that follows a relational model</p></li>
<li><p>Used to interact with RDBMS: create (query), modify, delete data (also manage access)</p>
<ul>
<li>Even under the <code>dplyr</code> / <code>dbplyr</code> hood</li>
</ul></li>
</ul>
</section>
<section id="sql-history" class="slide level2">
<h2>SQL history</h2>
<ul>
<li><p>Introduced in the 1970s</p></li>
<li><p>Based on <strong>relational algebra</strong> (algebraic structures for modeling tuples of data), popularized by Edgar Codd (1970, Turing Award, IBM)</p></li>
<li><p>Developed by Donald Clamberlin and Raymond Boyce (IBM) and initially called SEQUEL (trademark issue)</p></li>
<li><p>First commercially available in 1979 from IBM</p></li>
<li><p>Also in 1979, Relational Software, Inc released Oracle V2 (targeted for US Navy, CIA)</p></li>
<li><p>ANSI / ISO “standards” <span class="math inline">\(\ldots\)</span> but not!</p></li>
<li><p><strong>Most widely used database language</strong></p></li>
</ul>
</section>
<section id="sql-vs-nosql" class="slide level2">
<h2>SQL vs noSQL</h2>
<div class="quarto-layout-panel" data-layout="[50,50]">
<div class="quarto-layout-row">
<div id="first-column" class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><strong>SQL</strong></p>
<ul>
<li><p>Relational</p></li>
<li><p>Transactional</p></li>
<li><p>When in doubt: your best bet!</p></li>
</ul>
</div>
<div id="second-column" class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><strong>NoSQL</strong></p>
<ul>
<li><p>Value-keys, documents, wide-column (column-store), graphs</p></li>
<li><p>Distributed (arguably scalable)</p></li>
</ul>
</div>
</div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Vector databases (noSQL)</strong></p>
</div>
<div class="callout-content">
<p>Store / manage / search vector embeddings of unstructured data; very useful for <strong>retrieval augmented generation</strong> (RAG) with LLMs</p>
</div>
</div>
</div>
</section>
<section id="sql-syntax" class="slide level2">
<h2>SQL syntax</h2>
<p>We will learn (mostly) by example. It is relatively easy, except for <strong>nested expressions</strong> (subqueries)</p>
<p>Important commands:</p>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span><span class="kw">columns</span><span class="op">&gt;</span>          (<span class="dv">4</span>)</span>
<span id="cb1-2"><a aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">&lt;</span><span class="kw">table</span> <span class="op">/</span> subquery<span class="op">&gt;</span>   (<span class="dv">1</span>)</span>
<span id="cb1-3"><a aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="op">&lt;</span>predicate <span class="kw">on</span> <span class="kw">rows</span><span class="op">&gt;</span> (<span class="dv">2</span>) opt</span>
<span id="cb1-4"><a aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="op">&lt;</span><span class="kw">columns</span><span class="op">&gt;</span>        (<span class="dv">3</span>) opt</span>
<span id="cb1-5"><a aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="op">&lt;</span><span class="kw">columns</span><span class="op">&gt;</span>        (<span class="dv">5</span>) opt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-layout-panel" data-layout="[33,33,33]">
<div class="quarto-layout-row">
<div id="first-column" class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<p>Data query <br> language:</p>
</div>
<div id="second-column" class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<p>Data manipulation language:</p>
<ul>
<li><code>INSERT</code></li>
<li><code>UPDATE</code></li>
<li><code>DELETE</code></li>
</ul>
</div>
<div id="third-column" class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<p>Data definition language:</p>
<ul>
<li><code>CREATE</code></li>
<li><code>DROP</code></li>
<li><code>TRUNCATE</code></li>
</ul>
</div>
</div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Above is not a <strong>exhaustive</strong> list of commands</strong></p>
</div>
<div class="callout-content">

</div>
</div>
</div>
</section>
<section id="connecting-to-various-rdbms" class="slide level2 scrollable">
<h2>Connecting to various RDBMS</h2>
<p><code>DatabaseConnector</code> is an R package for connecting to various RDBMS using Java’s JDBC drivers (broad compatibility)</p>
<ul>
<li>SQL Server, Oracle, PostgreSQL, PDW, Snowflake, Spark, RedShift, Azure Synapse, BigQuery, Netezza, Impala, SQLite, DuckDB</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"DatabaseConnector"</span>) <span class="co"># Available on CRAN</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Simple connection to our synthetic database</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DatabaseConnector)</span>
<span id="cb3-2"><a aria-hidden="true" tabindex="-1"></a>absoluteFileName <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"data"</span>, <span class="st">"synthetic.duckdb"</span>)</span>
<span id="cb3-3"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb3-5"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT COUNT(*) AS subjects FROM person;"</span></span>
<span id="cb3-6"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a aria-hidden="true" tabindex="-1"></a><span class="fu">querySql</span>(<span class="at">connection =</span> connection,</span>
<span id="cb3-8"><a aria-hidden="true" tabindex="-1"></a>         <span class="at">sql =</span> sql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  SUBJECTS
1    1e+06</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">disconnect</span>(connection)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>New SQL commands</strong></p>
</div>
<div class="callout-content">
<ul>
<li><code>*</code> - match all columns</li>
<li><code>COUNT()</code> - total all rows</li>
<li><code>AS</code> - rename resulting object</li>
</ul>
</div>
</div>
</div>
</section>
<section id="via-higher-level-dplyr-dbplyr" class="slide level2 scrollable">
<h2>Via higher-level <code>dplyr</code> / <code>dbplyr</code></h2>
<p>For limited RDBMS (PostgreSQL, SQLite, DuckDB), we may use <code>dplyr</code> directly</p>
<ul>
<li>Rarely sufficient for production-scale deployment, maybe OK for research</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-2"><a aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb6-3"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a aria-hidden="true" tabindex="-1"></a>person <span class="ot">&lt;-</span> <span class="fu">tbl</span>(connection, <span class="st">"person"</span>)         <span class="co"># table reference (not in-memory)</span></span>
<span id="cb6-5"><a aria-hidden="true" tabindex="-1"></a>concept <span class="ot">&lt;-</span> <span class="fu">tbl</span>(connection, <span class="st">"concept"</span>)       <span class="co"># table reference</span></span>
<span id="cb6-6"><a aria-hidden="true" tabindex="-1"></a>vocabulary <span class="ot">&lt;-</span> <span class="fu">tbl</span>(connection, <span class="st">"vocabulary"</span>) <span class="co"># table reference</span></span>
<span id="cb6-7"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a aria-hidden="true" tabindex="-1"></a>person <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gender_concept_id) <span class="sc">%&gt;%</span>  <span class="co"># execute query</span></span>
<span id="cb6-9"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [2 x 2]
# Database: DatabaseConnectorDbiConnection
  gender_concept_id  count
              &lt;dbl&gt;  &lt;dbl&gt;
1              8507 499621
2              8532 500379</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a aria-hidden="true" tabindex="-1"></a>person <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gender_concept_id) <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()                <span class="co"># remember GROUP BY is higher priority than SELECT</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT gender_concept_id, COUNT(*) AS count
FROM person
GROUP BY gender_concept_id</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a aria-hidden="true" tabindex="-1"></a>person <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gender_concept_id) <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(concept <span class="sc">%&gt;%</span> <span class="fu">select</span>(concept_id, concept_name), </span>
<span id="cb10-4"><a aria-hidden="true" tabindex="-1"></a>             <span class="at">by=</span><span class="fu">c</span>(<span class="st">"gender_concept_id"</span> <span class="ot">=</span> <span class="st">"concept_id"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [2 x 3]
# Database: DatabaseConnectorDbiConnection
  gender_concept_id  count concept_name
              &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;       
1              8532 500379 FEMALE      
2              8507 499621 MALE        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a aria-hidden="true" tabindex="-1"></a>person <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gender_concept_id) <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(concept <span class="sc">%&gt;%</span> <span class="fu">select</span>(concept_id, concept_name), </span>
<span id="cb12-4"><a aria-hidden="true" tabindex="-1"></a>             <span class="at">by=</span><span class="fu">c</span>(<span class="st">"gender_concept_id"</span> <span class="ot">=</span> <span class="st">"concept_id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()                  <span class="co"># note the subquery</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT LHS.*, concept_name
FROM (
  SELECT gender_concept_id, COUNT(*) AS count
  FROM person
  GROUP BY gender_concept_id
) LHS
INNER JOIN concept
  ON (LHS.gender_concept_id = concept.concept_id)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">disconnect</span>(connection)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong><code>show_query()</code> is often a good starting-point</strong></p>
</div>
<div class="callout-content">
<p><span class="math inline">\(\ldots\)</span> a major short-coming of <code>dplyr</code> is its lack of cross-RDMS support</p>
</div>
</div>
</div>
</section>
<section id="handling-sql-dialects" class="slide level2">
<h2>Handling SQL dialects</h2>
<p>A simple example of SQL variation across RDBMS:</p>
<div class="quarto-layout-panel" data-layout="[50,50]">
<div class="quarto-layout-row">
<div id="first-column" class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><strong>SQL Server</strong></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><a aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> TOP <span class="dv">10</span> <span class="op">*</span> <span class="kw">FROM</span> person;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="second-column" class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><strong>PostgreSQL</strong></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><a aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> person <span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<ul>
<li>Solution: <code>SqlRender</code> package can translate from <strong>one standard dialect</strong> (OHDSI SQL) to all other supported dialects <span class="math inline">\(\ldots\)</span> write once; use many!
<ul>
<li>OHDSI SQL is mainly a subset of the SQL Server dialect</li>
</ul></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"SqlRender"</span>) <span class="co"># Available on CRAN</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"SqlRender"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sql-parameterization" class="slide level2 scrollable">
<h2>SQL parameterization</h2>
<p><code>SqlRender</code> also provides programmatic <strong>parameterization</strong> via a simple markup syntax (using the <code>@</code> prefix for parameters) of</p>
<ul>
<li>SQL values</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM concept WHERE concept_id = @a;"</span></span>
<span id="cb19-2"><a aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql, <span class="at">a =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM concept WHERE concept_id = 123;"</code></pre>
</div>
</div>
<ul>
<li>SQL tables and fields (<strong>not</strong> provided by most RDBMS)</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM @x WHERE person_id = @a;"</span></span>
<span id="cb21-2"><a aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql, <span class="at">x =</span> <span class="st">"observation"</span>, <span class="at">a =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM observation WHERE person_id = 123;"</code></pre>
</div>
</div>
<p><br></p>
<p>Parameter values can numbers, strings, booleans and (conveniently) even vectors</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM concept WHERE concept_id IN (@a);"</span></span>
<span id="cb23-2"><a aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql, <span class="at">a =</span> <span class="fu">c</span>(<span class="dv">123</span>, <span class="dv">234</span>, <span class="dv">345</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM concept WHERE concept_id IN (123,234,345);"</code></pre>
</div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>New SQL commands</strong></p>
</div>
<div class="callout-content">
<ul>
<li><code>WHERE</code> - optional <code>SELECT</code> clause to limit rows</li>
<li><code>IN</code> - is field value contained in list?</li>
</ul>
</div>
</div>
</div>
</section>
<section id="sql-translation" class="slide level2 scrollable">
<h2>SQL translation</h2>
<p><code>SqlRender</code> in action:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT TOP 10 * FROM person;"</span></span>
<span id="cb25-2"><a aria-hidden="true" tabindex="-1"></a><span class="fu">translate</span>(sql, <span class="at">targetDialect =</span> <span class="st">"postgresql"</span>) <span class="co"># specify the target dialect</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT  * FROM person LIMIT 10;"
attr(,"sqlDialect")
[1] "postgresql"</code></pre>
</div>
</div>
<p><br></p>
<p><code>SqlRender</code> translates most SQL functions</p>
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;">Function</th>
<th style="text-align: left;">Function</th>
<th style="text-align: left;">Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ABS</td>
<td style="text-align: left;">EXP</td>
<td style="text-align: left;">RAND</td>
</tr>
<tr class="even">
<td style="text-align: left;">ACOS</td>
<td style="text-align: left;">FLOOR</td>
<td style="text-align: left;">RANK</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ASIN</td>
<td style="text-align: left;">GETDATE</td>
<td style="text-align: left;">RIGHT</td>
</tr>
<tr class="even">
<td style="text-align: left;">ATAN</td>
<td style="text-align: left;">HASHBYTES*</td>
<td style="text-align: left;">ROUND</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AVG</td>
<td style="text-align: left;">ISNULL</td>
<td style="text-align: left;">ROW_NUMBER</td>
</tr>
<tr class="even">
<td style="text-align: left;">CAST</td>
<td style="text-align: left;">ISNUMERIC</td>
<td style="text-align: left;">RTRIM</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CEILING</td>
<td style="text-align: left;">LEFT</td>
<td style="text-align: left;">SIN</td>
</tr>
<tr class="even">
<td style="text-align: left;">CHARINDEX</td>
<td style="text-align: left;">LEN</td>
<td style="text-align: left;">SQRT</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CONCAT</td>
<td style="text-align: left;">LOG</td>
<td style="text-align: left;">SQUARE</td>
</tr>
<tr class="even">
<td style="text-align: left;">COS</td>
<td style="text-align: left;">LOG10</td>
<td style="text-align: left;">STDEV</td>
</tr>
<tr class="odd">
<td style="text-align: left;">COUNT</td>
<td style="text-align: left;">LOWER</td>
<td style="text-align: left;">SUM</td>
</tr>
<tr class="even">
<td style="text-align: left;">COUNT_BIG</td>
<td style="text-align: left;">LTRIM</td>
<td style="text-align: left;">TAN</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DATEADD</td>
<td style="text-align: left;">MAX</td>
<td style="text-align: left;">UPPER</td>
</tr>
<tr class="even">
<td style="text-align: left;">DATEDIFF</td>
<td style="text-align: left;">MIN</td>
<td style="text-align: left;">VAR</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DATEFROMPARTS</td>
<td style="text-align: left;">MONTH</td>
<td style="text-align: left;">YEAR</td>
</tr>
<tr class="even">
<td style="text-align: left;">DATETIMEFROMPARTS</td>
<td style="text-align: left;">NEWID</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">DAY</td>
<td style="text-align: left;">PI</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">EOMONTH</td>
<td style="text-align: left;">POWER</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>* Requires special privileges on Oracle. Has no equivalent on SQLite</p>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>New or useful SQL commands</strong></p>
</div>
<div class="callout-content">
<ul>
<li><code>TOP</code> - select only the first set of rows</li>
<li><code>DATEDIFF()</code> - compute the difference btw two dates in # of <code>DAY</code>, <code>MONTH</code> or <code>YEAR</code> intervals</li>
<li><code>AVG()</code> / <code>MIN()</code> / <code>MAX()</code> - should be obvious</li>
</ul>
</div>
</div>
</div>
</section>
<section id="conditional-sql-generation" class="slide level2">
<h2>Conditional SQL generation</h2>
<p>To turn blocks of code on or off based on the parameter values, <code>SqlRender</code> adds a ternary operator:</p>
<ul>
<li><code>{ Condition } ? { if true } : { if false }</code></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM cohort {@x == 1} ? {WHERE subject_id = 1};"</span></span>
<span id="cb27-2"><a aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql,<span class="at">x =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM cohort WHERE subject_id = 1;"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql,<span class="at">x =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM cohort ;"</code></pre>
</div>
</div>
</section>
<section id="databases-and-schema" class="slide level2">
<h2>Databases and schema</h2>
<p>Different RDBMS handle collections of tables differently</p>
<ul>
<li><p>Some enforce a single <code>database</code> with multiple <code>schema</code></p></li>
<li><p>Others enforce multiple <code>database</code>s each with a single <code>schema</code></p></li>
</ul>
<p>Solution: concatenate <code>database</code> and <code>schema</code> into single parameter <code>@databaseSchema</code></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb31-1"><a aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> @databaseSchema.person</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><strong>SQL Server</strong> - <code>databaseSchema = "cdm_data.dbo"</code></p></li>
<li><p><strong>PostgreSQL</strong> - <code>databaseSchema = "cdm_data"</code></p></li>
</ul>
</section>
<section id="simple-sql-function-example" class="slide level2 scrollable">
<h2>Simple SQL function example</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb32-2"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb32-4"><a aria-hidden="true" tabindex="-1"></a><span class="st">SELECT MAX(YEAR(observation_period_end_date) -</span></span>
<span id="cb32-5"><a aria-hidden="true" tabindex="-1"></a><span class="st">           year_of_birth) AS max_age</span></span>
<span id="cb32-6"><a aria-hidden="true" tabindex="-1"></a><span class="st">FROM @cdm.person</span></span>
<span id="cb32-7"><a aria-hidden="true" tabindex="-1"></a><span class="st">INNER JOIN @cdm.observation_period</span></span>
<span id="cb32-8"><a aria-hidden="true" tabindex="-1"></a><span class="st">  ON person.person_id = observation_period.person_id;</span></span>
<span id="cb32-9"><a aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb32-10"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateQuerySql</span>(<span class="at">connection =</span> connection, <span class="at">sql =</span> sql,</span>
<span id="cb32-12"><a aria-hidden="true" tabindex="-1"></a>                        <span class="at">cdm =</span> <span class="st">"synthetic.main"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  MAX_AGE
1     111</code></pre>
</div>
</div>
<p>or</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb34-2"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb34-4"><a aria-hidden="true" tabindex="-1"></a><span class="st">SELECT MAX(DATEDIFF(</span></span>
<span id="cb34-5"><a aria-hidden="true" tabindex="-1"></a><span class="st">          YEAR, birth_datetime, observation_period_end_date)</span></span>
<span id="cb34-6"><a aria-hidden="true" tabindex="-1"></a><span class="st">       ) AS max_age</span></span>
<span id="cb34-7"><a aria-hidden="true" tabindex="-1"></a><span class="st">FROM @cdm.person</span></span>
<span id="cb34-8"><a aria-hidden="true" tabindex="-1"></a><span class="st">INNER JOIN @cdm.observation_period</span></span>
<span id="cb34-9"><a aria-hidden="true" tabindex="-1"></a><span class="st">  ON person.person_id = observation_period.person_id;</span></span>
<span id="cb34-10"><a aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb34-11"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateQuerySql</span>(<span class="at">connection =</span> connection, <span class="at">sql =</span> sql,</span>
<span id="cb34-13"><a aria-hidden="true" tabindex="-1"></a>                        <span class="at">cdm =</span> <span class="st">"synthetic.main"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  MAX_AGE
1     111</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a aria-hidden="true" tabindex="-1"></a><span class="fu">disconnect</span>(connection)</span>
<span id="cb36-2"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">translate</span>(sql, <span class="at">targetDialect =</span> <span class="st">"duckdb"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SELECT MAX((EXTRACT(YEAR FROM CAST(observation_period_end_date AS DATE)) - EXTRACT(YEAR FROM CAST(birth_datetime AS DATE)))
       ) AS max_age
FROM @cdm.person
INNER JOIN @cdm.observation_period
  ON person.person_id = observation_period.person_id;</code></pre>
</div>
</div>
</section>
<section id="incidence-rate-study" class="slide level2 scrollable">
<h2>Incidence rate study</h2>
<p>ACE inhibitors are the most popular treatment for essential hypertension. Hypertensive patients suffer from acute myocardial infarctions (AMI). What is rate of AMI in the first year following lisinopril treatment initiation, stratified by age and gender?</p>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>The <strong>hard</strong> way</strong></p>
</div>
<div class="callout-content">
<p>Before OHDSI standardization, every analysis in every database was separately (and often poorly) hand-coded <span class="math inline">\(\ldots\)</span> like we will do here</p>
</div>
</div>
</div>
<p>We need to define (and implement in SQL)</p>
<ul>
<li><p><strong>Exposure</strong> - first exposure to lisinopril with <span class="math inline">\(\ge\)</span> 365 days of observation prior to first exposure. NB: overly simplified for clinical use</p></li>
<li><p><strong>Outcome</strong> - any occurrence of an acute myocardial infarction diagnosis code during an inpatient or emergency room (ER) visit</p></li>
<li><p><strong>Time-at-risk</strong> - compute the incidence rate of <strong>outcome</strong> in the first year after <strong>exposure</strong></p></li>
</ul>
</section>
<section id="create-a-cohort-table" class="slide level2 scrollable">
<h2>Create a <code>COHORT</code> table</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a aria-hidden="true" tabindex="-1"></a>conn <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb38-2"><a aria-hidden="true" tabindex="-1"></a>cdmDbSchema <span class="ot">&lt;-</span> <span class="st">"synthetic.main"</span></span>
<span id="cb38-3"><a aria-hidden="true" tabindex="-1"></a>cohortDbSchema <span class="ot">&lt;-</span> <span class="st">"synthetic.main"</span>  <span class="co"># often somewhere else</span></span>
<span id="cb38-4"><a aria-hidden="true" tabindex="-1"></a>cohortTable <span class="ot">&lt;-</span> <span class="st">"my_cohorts"</span></span>
<span id="cb38-5"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb38-7"><a aria-hidden="true" tabindex="-1"></a><span class="st">DROP TABLE IF EXISTS @cohort_db_schema.@cohort_table;</span></span>
<span id="cb38-8"><a aria-hidden="true" tabindex="-1"></a><span class="st">CREATE TABLE @cohort_db_schema.@cohort_table (</span></span>
<span id="cb38-9"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_definition_id INT,</span></span>
<span id="cb38-10"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_start_date DATE,</span></span>
<span id="cb38-11"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_end_date DATE,</span></span>
<span id="cb38-12"><a aria-hidden="true" tabindex="-1"></a><span class="st">  subject_id BIGINT</span></span>
<span id="cb38-13"><a aria-hidden="true" tabindex="-1"></a><span class="st">);</span></span>
<span id="cb38-14"><a aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb38-15"><a aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateExecuteSql</span>(conn, sql,</span>
<span id="cb38-16"><a aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_db_schema =</span> cohortDbSchema,</span>
<span id="cb38-17"><a aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_table =</span> cohortTable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="build-exposure-cohort" class="slide level2 scrollable">
<h2>Build exposure cohort</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb39-2"><a aria-hidden="true" tabindex="-1"></a><span class="st">INSERT INTO @cohort_db_schema.@cohort_table (</span></span>
<span id="cb39-3"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_definition_id,</span></span>
<span id="cb39-4"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_start_date,</span></span>
<span id="cb39-5"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_end_date,</span></span>
<span id="cb39-6"><a aria-hidden="true" tabindex="-1"></a><span class="st">  subject_id</span></span>
<span id="cb39-7"><a aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb39-8"><a aria-hidden="true" tabindex="-1"></a><span class="st">SELECT 1 AS cohort_definition_id,</span></span>
<span id="cb39-9"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_start_date,</span></span>
<span id="cb39-10"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_end_date,</span></span>
<span id="cb39-11"><a aria-hidden="true" tabindex="-1"></a><span class="st">  subject_id</span></span>
<span id="cb39-12"><a aria-hidden="true" tabindex="-1"></a><span class="st">FROM (</span></span>
<span id="cb39-13"><a aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT drug_era_start_date AS cohort_start_date,</span></span>
<span id="cb39-14"><a aria-hidden="true" tabindex="-1"></a><span class="st">    drug_era_end_date AS cohort_end_date,</span></span>
<span id="cb39-15"><a aria-hidden="true" tabindex="-1"></a><span class="st">    person_id AS subject_id</span></span>
<span id="cb39-16"><a aria-hidden="true" tabindex="-1"></a><span class="st">  FROM (</span></span>
<span id="cb39-17"><a aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT drug_era_start_date,</span></span>
<span id="cb39-18"><a aria-hidden="true" tabindex="-1"></a><span class="st">      drug_era_end_date,</span></span>
<span id="cb39-19"><a aria-hidden="true" tabindex="-1"></a><span class="st">      person_id,</span></span>
<span id="cb39-20"><a aria-hidden="true" tabindex="-1"></a><span class="st">      ROW_NUMBER() OVER (</span></span>
<span id="cb39-21"><a aria-hidden="true" tabindex="-1"></a><span class="st">        PARTITION BY person_id</span></span>
<span id="cb39-22"><a aria-hidden="true" tabindex="-1"></a><span class="st">            ORDER BY drug_era_start_date</span></span>
<span id="cb39-23"><a aria-hidden="true" tabindex="-1"></a><span class="st">      ) order_nr</span></span>
<span id="cb39-24"><a aria-hidden="true" tabindex="-1"></a><span class="st">    FROM @cdm_db_schema.drug_era</span></span>
<span id="cb39-25"><a aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE drug_concept_id = 1308216 -- Lisinopril</span></span>
<span id="cb39-26"><a aria-hidden="true" tabindex="-1"></a><span class="st">  ) ordered_exposures</span></span>
<span id="cb39-27"><a aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE order_nr = 1</span></span>
<span id="cb39-28"><a aria-hidden="true" tabindex="-1"></a><span class="st">) first_era</span></span>
<span id="cb39-29"><a aria-hidden="true" tabindex="-1"></a><span class="st">INNER JOIN @cdm_db_schema.observation_period</span></span>
<span id="cb39-30"><a aria-hidden="true" tabindex="-1"></a><span class="st">  ON subject_id = person_id</span></span>
<span id="cb39-31"><a aria-hidden="true" tabindex="-1"></a><span class="st">    AND observation_period_start_date &lt; cohort_start_date</span></span>
<span id="cb39-32"><a aria-hidden="true" tabindex="-1"></a><span class="st">    AND observation_period_end_date &gt; cohort_start_date</span></span>
<span id="cb39-33"><a aria-hidden="true" tabindex="-1"></a><span class="st">WHERE DATEDIFF(DAY,</span></span>
<span id="cb39-34"><a aria-hidden="true" tabindex="-1"></a><span class="st">               observation_period_start_date,</span></span>
<span id="cb39-35"><a aria-hidden="true" tabindex="-1"></a><span class="st">               cohort_start_date) &gt;= 365;</span></span>
<span id="cb39-36"><a aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb39-37"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-38"><a aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateExecuteSql</span>(conn, sql,</span>
<span id="cb39-39"><a aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_db_schema =</span> cohortDbSchema,</span>
<span id="cb39-40"><a aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_table =</span> cohortTable,</span>
<span id="cb39-41"><a aria-hidden="true" tabindex="-1"></a>                          <span class="at">cdm_db_schema =</span> cdmDbSchema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Notes</strong></p>
</div>
<div class="callout-content">
<ul>
<li>Take first drug exposure per person from <code>DRUG_ERA</code></li>
<li>Join to <code>OBSERVATION_PERIOD</code> during exposure and require prior observation time</li>
</ul>
</div>
</div>
</div>
</section>
<section id="build-outcome-cohort" class="slide level2 scrollable">
<h2>Build outcome cohort</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb40-2"><a aria-hidden="true" tabindex="-1"></a><span class="st">INSERT INTO @cohort_db_schema.@cohort_table (</span></span>
<span id="cb40-3"><a aria-hidden="true" tabindex="-1"></a><span class="st"> cohort_definition_id,</span></span>
<span id="cb40-4"><a aria-hidden="true" tabindex="-1"></a><span class="st"> cohort_start_date,</span></span>
<span id="cb40-5"><a aria-hidden="true" tabindex="-1"></a><span class="st"> cohort_end_date,</span></span>
<span id="cb40-6"><a aria-hidden="true" tabindex="-1"></a><span class="st">subject_id</span></span>
<span id="cb40-7"><a aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb40-8"><a aria-hidden="true" tabindex="-1"></a><span class="st">SELECT 2 AS cohort_definition_id,</span></span>
<span id="cb40-9"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_start_date,</span></span>
<span id="cb40-10"><a aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_end_date,</span></span>
<span id="cb40-11"><a aria-hidden="true" tabindex="-1"></a><span class="st">  subject_id</span></span>
<span id="cb40-12"><a aria-hidden="true" tabindex="-1"></a><span class="st">FROM (</span></span>
<span id="cb40-13"><a aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT DISTINCT person_id AS subject_id,</span></span>
<span id="cb40-14"><a aria-hidden="true" tabindex="-1"></a><span class="st">    condition_start_date AS cohort_start_date,</span></span>
<span id="cb40-15"><a aria-hidden="true" tabindex="-1"></a><span class="st">    condition_end_date AS cohort_end_date</span></span>
<span id="cb40-16"><a aria-hidden="true" tabindex="-1"></a><span class="st">  FROM @cdm_db_schema.condition_occurrence</span></span>
<span id="cb40-17"><a aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cdm_db_schema.concept_ancestor</span></span>
<span id="cb40-18"><a aria-hidden="true" tabindex="-1"></a><span class="st">    ON condition_concept_id = descendant_concept_id</span></span>
<span id="cb40-19"><a aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE ancestor_concept_id = 4329847 -- Acute MI</span></span>
<span id="cb40-20"><a aria-hidden="true" tabindex="-1"></a><span class="st">) distinct_occurrence</span></span>
<span id="cb40-21"><a aria-hidden="true" tabindex="-1"></a><span class="st">INNER JOIN @cdm_db_schema.visit_occurrence</span></span>
<span id="cb40-22"><a aria-hidden="true" tabindex="-1"></a><span class="st">  ON subject_id = person_id</span></span>
<span id="cb40-23"><a aria-hidden="true" tabindex="-1"></a><span class="st">  AND visit_start_date &lt;= cohort_start_date</span></span>
<span id="cb40-24"><a aria-hidden="true" tabindex="-1"></a><span class="st">  AND visit_end_date &gt;= cohort_start_date</span></span>
<span id="cb40-25"><a aria-hidden="true" tabindex="-1"></a><span class="st">WHERE visit_concept_id IN (262, 9203,</span></span>
<span id="cb40-26"><a aria-hidden="true" tabindex="-1"></a><span class="st">    9201) -- Inpatient or ER;</span></span>
<span id="cb40-27"><a aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb40-28"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateExecuteSql</span>(conn, sql,</span>
<span id="cb40-30"><a aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_db_schema =</span> cohortDbSchema,</span>
<span id="cb40-31"><a aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_table =</span> cohortTable,</span>
<span id="cb40-32"><a aria-hidden="true" tabindex="-1"></a>                          <span class="at">cdm_db_schema =</span> cdmDbSchema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Notes</strong></p>
</div>
<div class="callout-content">
<ul>
<li>Join <code>CONDITION_OCCURRENCE</code> to <code>CONCEPT_ANCESTOR</code> to find all occurrences of AMI or any of its descendents (more later)</li>
<li>Use <code>DISTINCT</code> to select at most one record per day</li>
<li>Join <code>VISIT_OCCURENCE</code> to ensure diagnosis was in-patient or ER</li>
</ul>
</div>
</div>
</div>
</section>
<section id="calculate-incidence-rate" class="slide level2 scrollable">
<h2>Calculate incidence rate</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb41-2"><a aria-hidden="true" tabindex="-1"></a><span class="st">WITH tar AS (</span></span>
<span id="cb41-3"><a aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT concept_name AS gender,</span></span>
<span id="cb41-4"><a aria-hidden="true" tabindex="-1"></a><span class="st">    FLOOR((YEAR(cohort_start_date) -</span></span>
<span id="cb41-5"><a aria-hidden="true" tabindex="-1"></a><span class="st">          year_of_birth) / 10) AS age,</span></span>
<span id="cb41-6"><a aria-hidden="true" tabindex="-1"></a><span class="st">    subject_id,</span></span>
<span id="cb41-7"><a aria-hidden="true" tabindex="-1"></a><span class="st">    cohort_start_date,</span></span>
<span id="cb41-8"><a aria-hidden="true" tabindex="-1"></a><span class="st">    CASE WHEN DATEADD(DAY, 365, cohort_start_date) &gt;</span></span>
<span id="cb41-9"><a aria-hidden="true" tabindex="-1"></a><span class="st">      observation_period_end_date</span></span>
<span id="cb41-10"><a aria-hidden="true" tabindex="-1"></a><span class="st">    THEN observation_period_end_date</span></span>
<span id="cb41-11"><a aria-hidden="true" tabindex="-1"></a><span class="st">    ELSE DATEADD(DAY, 365, cohort_start_date)</span></span>
<span id="cb41-12"><a aria-hidden="true" tabindex="-1"></a><span class="st">    END AS cohort_end_date</span></span>
<span id="cb41-13"><a aria-hidden="true" tabindex="-1"></a><span class="st">  FROM @cohort_db_schema.@cohort_table</span></span>
<span id="cb41-14"><a aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cdm_db_schema.observation_period</span></span>
<span id="cb41-15"><a aria-hidden="true" tabindex="-1"></a><span class="st">    ON subject_id = observation_period.person_id</span></span>
<span id="cb41-16"><a aria-hidden="true" tabindex="-1"></a><span class="st">      AND observation_period_start_date &lt; cohort_start_date</span></span>
<span id="cb41-17"><a aria-hidden="true" tabindex="-1"></a><span class="st">      AND observation_period_end_date &gt; cohort_start_date</span></span>
<span id="cb41-18"><a aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cdm_db_schema.person</span></span>
<span id="cb41-19"><a aria-hidden="true" tabindex="-1"></a><span class="st">    ON subject_id = person.person_id</span></span>
<span id="cb41-20"><a aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cdm_db_schema.concept</span></span>
<span id="cb41-21"><a aria-hidden="true" tabindex="-1"></a><span class="st">    ON gender_concept_id = concept_id</span></span>
<span id="cb41-22"><a aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE cohort_definition_id = 1 -- Exposure</span></span>
<span id="cb41-23"><a aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb41-24"><a aria-hidden="true" tabindex="-1"></a><span class="st">SELECT days.gender,</span></span>
<span id="cb41-25"><a aria-hidden="true" tabindex="-1"></a><span class="st">    days.age,</span></span>
<span id="cb41-26"><a aria-hidden="true" tabindex="-1"></a><span class="st">    days,</span></span>
<span id="cb41-27"><a aria-hidden="true" tabindex="-1"></a><span class="st">    CASE WHEN events IS NULL THEN 0 ELSE events END AS events</span></span>
<span id="cb41-28"><a aria-hidden="true" tabindex="-1"></a><span class="st">FROM (</span></span>
<span id="cb41-29"><a aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT gender,</span></span>
<span id="cb41-30"><a aria-hidden="true" tabindex="-1"></a><span class="st">    age,</span></span>
<span id="cb41-31"><a aria-hidden="true" tabindex="-1"></a><span class="st">    SUM(DATEDIFF(DAY, cohort_start_date,</span></span>
<span id="cb41-32"><a aria-hidden="true" tabindex="-1"></a><span class="st">      cohort_end_date)) AS days</span></span>
<span id="cb41-33"><a aria-hidden="true" tabindex="-1"></a><span class="st">  FROM tar</span></span>
<span id="cb41-34"><a aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY gender,</span></span>
<span id="cb41-35"><a aria-hidden="true" tabindex="-1"></a><span class="st">    age</span></span>
<span id="cb41-36"><a aria-hidden="true" tabindex="-1"></a><span class="st">) days</span></span>
<span id="cb41-37"><a aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN (</span></span>
<span id="cb41-38"><a aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT gender,</span></span>
<span id="cb41-39"><a aria-hidden="true" tabindex="-1"></a><span class="st">      age,</span></span>
<span id="cb41-40"><a aria-hidden="true" tabindex="-1"></a><span class="st">      COUNT(*) AS events</span></span>
<span id="cb41-41"><a aria-hidden="true" tabindex="-1"></a><span class="st">  FROM tar</span></span>
<span id="cb41-42"><a aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cohort_db_schema.@cohort_table ami</span></span>
<span id="cb41-43"><a aria-hidden="true" tabindex="-1"></a><span class="st">    ON tar.subject_id = ami.subject_id</span></span>
<span id="cb41-44"><a aria-hidden="true" tabindex="-1"></a><span class="st">      AND tar.cohort_start_date &lt;= ami.cohort_start_date</span></span>
<span id="cb41-45"><a aria-hidden="true" tabindex="-1"></a><span class="st">      AND tar.cohort_end_date &gt;= ami.cohort_start_date</span></span>
<span id="cb41-46"><a aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE cohort_definition_id = 2 -- Outcome</span></span>
<span id="cb41-47"><a aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY gender,</span></span>
<span id="cb41-48"><a aria-hidden="true" tabindex="-1"></a><span class="st">    age</span></span>
<span id="cb41-49"><a aria-hidden="true" tabindex="-1"></a><span class="st">) events</span></span>
<span id="cb41-50"><a aria-hidden="true" tabindex="-1"></a><span class="st">ON days.gender = events.gender</span></span>
<span id="cb41-51"><a aria-hidden="true" tabindex="-1"></a><span class="st">  AND days.age = events.age;</span></span>
<span id="cb41-52"><a aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb41-53"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-54"><a aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">renderTranslateQuerySql</span>(conn, sql,</span>
<span id="cb41-55"><a aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cohort_db_schema =</span> cohortDbSchema,</span>
<span id="cb41-56"><a aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cohort_table =</span> cohortTable,</span>
<span id="cb41-57"><a aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cdm_db_schema =</span> cdmDbSchema,</span>
<span id="cb41-58"><a aria-hidden="true" tabindex="-1"></a>                                   <span class="at">snakeCaseToCamelCase =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-59"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-60"><a aria-hidden="true" tabindex="-1"></a><span class="fu">disconnect</span>(conn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="examine-results" class="slide level2 scrollable">
<h2>Examine results</h2>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a aria-hidden="true" tabindex="-1"></a><span class="co"># Compute incidence rate (IR)</span></span>
<span id="cb42-2"><a aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>ir <span class="ot">&lt;-</span>  results<span class="sc">$</span>events <span class="sc">/</span> (results<span class="sc">$</span>days <span class="sc">/</span> <span class="fl">365.25</span>)</span>
<span id="cb42-3"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a aria-hidden="true" tabindex="-1"></a><span class="co"># Fix age scale</span></span>
<span id="cb42-5"><a aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>age <span class="ot">&lt;-</span> results<span class="sc">$</span>age <span class="sc">*</span> <span class="dv">10</span></span>
<span id="cb42-6"><a aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb42-8"><a aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> ir, <span class="at">group =</span> gender, <span class="at">color =</span> gender)) <span class="sc">+</span></span>
<span id="cb42-9"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb42-10"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Age"</span>) <span class="sc">+</span></span>
<span id="cb42-11"><a aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Incidence (per patient year)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout="[200]" data-layout-align="center">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="03_sql_files/figure-revealjs/unnamed-chunk-18-1.png" class="quarto-figure quarto-figure-center" style="width:9in"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="final-words" class="slide level2">
<h2>Final words</h2>
<p>One study, one database, one (almost unusable) script <span class="math inline">\(\ldots\)</span></p>

<img data-src="figures/current_approach_one_study_one_script.png" class="quarto-figure quarto-figure-center r-stretch" style="width:50.0%"><div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>You do <strong>not</strong> want to do things this way!</strong></p>
</div>
<div class="callout-content">

</div>
</div>
</div>


</section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<p><img src="figures/logo.png" class="slide-logo"></p>
<div class="footer footer-default">
<p>Biostat 218 - UCLA - Observational Health Data Sciences and Informatics (OHDSI)</p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1280,

        height: 720,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
            const codeEl = trigger.previousElementSibling.cloneNode(true);
            for (const childEl of codeEl.children) {
              if (isCodeAnnotation(childEl)) {
                childEl.remove();
              }
            }
            return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>