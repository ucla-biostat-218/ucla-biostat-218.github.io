<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Marc A Suchard @ UCLA">

<title>Structured query language</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-b6e6edf6cb1293d7f667c2f39c143ab5.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-4d7efdad13f00c6c270b530d954266f4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="floating quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#sql-purpose" id="toc-sql-purpose" class="nav-link" data-scroll-target="#sql-purpose"><span class="header-section-number">2</span> SQL purpose</a></li>
  <li><a href="#sql-history" id="toc-sql-history" class="nav-link" data-scroll-target="#sql-history"><span class="header-section-number">3</span> SQL history</a></li>
  <li><a href="#sql-vs-nosql" id="toc-sql-vs-nosql" class="nav-link" data-scroll-target="#sql-vs-nosql"><span class="header-section-number">4</span> SQL vs noSQL</a></li>
  <li><a href="#sql-syntax" id="toc-sql-syntax" class="nav-link" data-scroll-target="#sql-syntax"><span class="header-section-number">5</span> SQL syntax</a></li>
  <li><a href="#connecting-to-various-rdbms" id="toc-connecting-to-various-rdbms" class="nav-link" data-scroll-target="#connecting-to-various-rdbms"><span class="header-section-number">6</span> Connecting to various RDBMS</a></li>
  <li><a href="#via-higher-level-dplyr-dbplyr" id="toc-via-higher-level-dplyr-dbplyr" class="nav-link" data-scroll-target="#via-higher-level-dplyr-dbplyr"><span class="header-section-number">7</span> Via higher-level <code>dplyr</code> / <code>dbplyr</code></a></li>
  <li><a href="#handling-sql-dialects" id="toc-handling-sql-dialects" class="nav-link" data-scroll-target="#handling-sql-dialects"><span class="header-section-number">8</span> Handling SQL dialects</a></li>
  <li><a href="#sql-parameterization" id="toc-sql-parameterization" class="nav-link" data-scroll-target="#sql-parameterization"><span class="header-section-number">9</span> SQL parameterization</a></li>
  <li><a href="#sql-translation" id="toc-sql-translation" class="nav-link" data-scroll-target="#sql-translation"><span class="header-section-number">10</span> SQL translation</a></li>
  <li><a href="#conditional-sql-generation" id="toc-conditional-sql-generation" class="nav-link" data-scroll-target="#conditional-sql-generation"><span class="header-section-number">11</span> Conditional SQL generation</a></li>
  <li><a href="#databases-and-schema" id="toc-databases-and-schema" class="nav-link" data-scroll-target="#databases-and-schema"><span class="header-section-number">12</span> Databases and schema</a></li>
  <li><a href="#simple-sql-function-example" id="toc-simple-sql-function-example" class="nav-link" data-scroll-target="#simple-sql-function-example"><span class="header-section-number">13</span> Simple SQL function example</a></li>
  <li><a href="#incidence-rate-study" id="toc-incidence-rate-study" class="nav-link" data-scroll-target="#incidence-rate-study"><span class="header-section-number">14</span> Incidence rate study</a></li>
  <li><a href="#create-a-cohort-table" id="toc-create-a-cohort-table" class="nav-link" data-scroll-target="#create-a-cohort-table"><span class="header-section-number">15</span> Create a <code>COHORT</code> table</a></li>
  <li><a href="#build-exposure-cohort" id="toc-build-exposure-cohort" class="nav-link" data-scroll-target="#build-exposure-cohort"><span class="header-section-number">16</span> Build exposure cohort</a></li>
  <li><a href="#build-outcome-cohort" id="toc-build-outcome-cohort" class="nav-link" data-scroll-target="#build-outcome-cohort"><span class="header-section-number">17</span> Build outcome cohort</a></li>
  <li><a href="#calculate-incidence-rate" id="toc-calculate-incidence-rate" class="nav-link" data-scroll-target="#calculate-incidence-rate"><span class="header-section-number">18</span> Calculate incidence rate</a></li>
  <li><a href="#examine-results" id="toc-examine-results" class="nav-link" data-scroll-target="#examine-results"><span class="header-section-number">19</span> Examine results</a></li>
  <li><a href="#final-words" id="toc-final-words" class="nav-link" data-scroll-target="#final-words"><span class="header-section-number">20</span> Final words</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="03_sql.revealjs.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Structured query language</h1>
<p class="subtitle lead">Biostat 218</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Marc A Suchard @ UCLA </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>In this lecture we will learn how to:</p>
<ul>
<li><p>Think about structured queries in databases</p></li>
<li><p>Support many different management systems</p></li>
<li><p>Handle different dialects</p></li>
<li><p>Write simple queries against the OMOP CDM</p></li>
</ul>
</section>
<section id="sql-purpose" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="sql-purpose"><span class="header-section-number">2</span> SQL purpose</h2>
<ul>
<li><p><strong>Domain-specific language</strong> (DSL) for relational database management systems (RDBMS)</p></li>
<li><p>Specialized to handle <strong>structured data</strong> that follows a relational model</p></li>
<li><p>Used to interact with RDBMS: create (query), modify, delete data (also manage access)</p>
<ul>
<li>Even under the <code>dplyr</code> / <code>dbplyr</code> hood</li>
</ul></li>
</ul>
</section>
<section id="sql-history" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sql-history"><span class="header-section-number">3</span> SQL history</h2>
<ul>
<li><p>Introduced in the 1970s</p></li>
<li><p>Based on <strong>relational algebra</strong> (algebraic structures for modeling tuples of data), popularized by Edgar Codd (1970, Turing Award, IBM)</p></li>
<li><p>Developed by Donald Clamberlin and Raymond Boyce (IBM) and initially called SEQUEL (trademark issue)</p></li>
<li><p>First commercially available in 1979 from IBM</p></li>
<li><p>Also in 1979, Relational Software, Inc released Oracle V2 (targeted for US Navy, CIA)</p></li>
<li><p>ANSI / ISO “standards” <span class="math inline">\(\ldots\)</span> but not!</p></li>
<li><p><strong>Most widely used database language</strong></p></li>
</ul>
</section>
<section id="sql-vs-nosql" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="sql-vs-nosql"><span class="header-section-number">4</span> SQL vs noSQL</h2>
<div class="quarto-layout-panel" data-layout="[50,50]">
<div class="quarto-layout-row">
<div id="first-column" class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><strong>SQL</strong></p>
<ul>
<li><p>Relational</p></li>
<li><p>Transactional</p></li>
<li><p>When in doubt: your best bet!</p></li>
</ul>
</div>
<div id="second-column" class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><strong>NoSQL</strong></p>
<ul>
<li><p>Value-keys, documents, wide-column (column-store), graphs</p></li>
<li><p>Distributed (arguably scalable)</p></li>
</ul>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Vector databases (noSQL)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Store / manage / search vector embeddings of unstructured data; very useful for <strong>retrieval augmented generation</strong> (RAG) with LLMs</p>
</div>
</div>
</section>
<section id="sql-syntax" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="sql-syntax"><span class="header-section-number">5</span> SQL syntax</h2>
<p>We will learn (mostly) by example. It is relatively easy, except for <strong>nested expressions</strong> (subqueries)</p>
<p>Important commands:</p>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span><span class="kw">columns</span><span class="op">&gt;</span>          (<span class="dv">4</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">&lt;</span><span class="kw">table</span> <span class="op">/</span> subquery<span class="op">&gt;</span>   (<span class="dv">1</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="op">&lt;</span>predicate <span class="kw">on</span> <span class="kw">rows</span><span class="op">&gt;</span> (<span class="dv">2</span>) opt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="op">&lt;</span><span class="kw">columns</span><span class="op">&gt;</span>        (<span class="dv">3</span>) opt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="op">&lt;</span><span class="kw">columns</span><span class="op">&gt;</span>        (<span class="dv">5</span>) opt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-layout-panel" data-layout="[33,33,33]">
<div class="quarto-layout-row">
<div id="first-column" class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<p>Data query <br> language:</p>
</div>
<div id="second-column" class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<p>Data manipulation language:</p>
<ul>
<li><code>INSERT</code></li>
<li><code>UPDATE</code></li>
<li><code>DELETE</code></li>
</ul>
</div>
<div id="third-column" class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<p>Data definition language:</p>
<ul>
<li><code>CREATE</code></li>
<li><code>DROP</code></li>
<li><code>TRUNCATE</code></li>
</ul>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Above is not a <strong>exhaustive</strong> list of commands
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
</section>
<section id="connecting-to-various-rdbms" class="level2 scrollable" data-number="6">
<h2 class="scrollable anchored" data-number="6" data-anchor-id="connecting-to-various-rdbms"><span class="header-section-number">6</span> Connecting to various RDBMS</h2>
<p><code>DatabaseConnector</code> is an R package for connecting to various RDBMS using Java’s JDBC drivers (broad compatibility)</p>
<ul>
<li>SQL Server, Oracle, PostgreSQL, PDW, Snowflake, Spark, RedShift, Azure Synapse, BigQuery, Netezza, Impala, SQLite, DuckDB</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"DatabaseConnector"</span>) <span class="co"># Available on CRAN</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Simple connection to our synthetic database</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DatabaseConnector)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>absoluteFileName <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"data"</span>, <span class="st">"synthetic.duckdb"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT COUNT(*) AS subjects FROM person;"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">querySql</span>(<span class="at">connection =</span> connection,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">sql =</span> sql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  SUBJECTS
1    1e+06</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">disconnect</span>(connection)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
New SQL commands
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>*</code> - match all columns</li>
<li><code>COUNT()</code> - total all rows</li>
<li><code>AS</code> - rename resulting object</li>
</ul>
</div>
</div>
</section>
<section id="via-higher-level-dplyr-dbplyr" class="level2 scrollable" data-number="7">
<h2 class="scrollable anchored" data-number="7" data-anchor-id="via-higher-level-dplyr-dbplyr"><span class="header-section-number">7</span> Via higher-level <code>dplyr</code> / <code>dbplyr</code></h2>
<p>For limited RDBMS (PostgreSQL, SQLite, DuckDB), we may use <code>dplyr</code> directly</p>
<ul>
<li>Rarely sufficient for production-scale deployment, maybe OK for research</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>person <span class="ot">&lt;-</span> <span class="fu">tbl</span>(connection, <span class="st">"person"</span>)         <span class="co"># table reference (not in-memory)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>concept <span class="ot">&lt;-</span> <span class="fu">tbl</span>(connection, <span class="st">"concept"</span>)       <span class="co"># table reference</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>vocabulary <span class="ot">&lt;-</span> <span class="fu">tbl</span>(connection, <span class="st">"vocabulary"</span>) <span class="co"># table reference</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>person <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gender_concept_id) <span class="sc">%&gt;%</span>  <span class="co"># execute query</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [2 x 2]
# Database: DatabaseConnectorDbiConnection
  gender_concept_id  count
              &lt;dbl&gt;  &lt;dbl&gt;
1              8507 499621
2              8532 500379</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>person <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gender_concept_id) <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()                <span class="co"># remember GROUP BY is higher priority than SELECT</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT gender_concept_id, COUNT(*) AS count
FROM person
GROUP BY gender_concept_id</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>person <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gender_concept_id) <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(concept <span class="sc">%&gt;%</span> <span class="fu">select</span>(concept_id, concept_name), </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">by=</span><span class="fu">c</span>(<span class="st">"gender_concept_id"</span> <span class="ot">=</span> <span class="st">"concept_id"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [2 x 3]
# Database: DatabaseConnectorDbiConnection
  gender_concept_id  count concept_name
              &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;       
1              8532 500379 FEMALE      
2              8507 499621 MALE        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>person <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gender_concept_id) <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(concept <span class="sc">%&gt;%</span> <span class="fu">select</span>(concept_id, concept_name), </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">by=</span><span class="fu">c</span>(<span class="st">"gender_concept_id"</span> <span class="ot">=</span> <span class="st">"concept_id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()                  <span class="co"># note the subquery</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT LHS.*, concept_name
FROM (
  SELECT gender_concept_id, COUNT(*) AS count
  FROM person
  GROUP BY gender_concept_id
) LHS
INNER JOIN concept
  ON (LHS.gender_concept_id = concept.concept_id)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">disconnect</span>(connection)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>show_query()</code> is often a good starting-point
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math inline">\(\ldots\)</span> a major short-coming of <code>dplyr</code> is its lack of cross-RDMS support</p>
</div>
</div>
</section>
<section id="handling-sql-dialects" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="handling-sql-dialects"><span class="header-section-number">8</span> Handling SQL dialects</h2>
<p>A simple example of SQL variation across RDBMS:</p>
<div class="quarto-layout-panel" data-layout="[50,50]">
<div class="quarto-layout-row">
<div id="first-column" class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><strong>SQL Server</strong></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> TOP <span class="dv">10</span> <span class="op">*</span> <span class="kw">FROM</span> person;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="second-column" class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<p><strong>PostgreSQL</strong></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> person <span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<ul>
<li>Solution: <code>SqlRender</code> package can translate from <strong>one standard dialect</strong> (OHDSI SQL) to all other supported dialects <span class="math inline">\(\ldots\)</span> write once; use many!
<ul>
<li>OHDSI SQL is mainly a subset of the SQL Server dialect</li>
</ul></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"SqlRender"</span>) <span class="co"># Available on CRAN</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"SqlRender"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sql-parameterization" class="level2 scrollable" data-number="9">
<h2 class="scrollable anchored" data-number="9" data-anchor-id="sql-parameterization"><span class="header-section-number">9</span> SQL parameterization</h2>
<p><code>SqlRender</code> also provides programmatic <strong>parameterization</strong> via a simple markup syntax (using the <code>@</code> prefix for parameters) of</p>
<ul>
<li>SQL values</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM concept WHERE concept_id = @a;"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql, <span class="at">a =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM concept WHERE concept_id = 123;"</code></pre>
</div>
</div>
<ul>
<li>SQL tables and fields (<strong>not</strong> provided by most RDBMS)</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM @x WHERE person_id = @a;"</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql, <span class="at">x =</span> <span class="st">"observation"</span>, <span class="at">a =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM observation WHERE person_id = 123;"</code></pre>
</div>
</div>
<p><br></p>
<p>Parameter values can numbers, strings, booleans and (conveniently) even vectors</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM concept WHERE concept_id IN (@a);"</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql, <span class="at">a =</span> <span class="fu">c</span>(<span class="dv">123</span>, <span class="dv">234</span>, <span class="dv">345</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM concept WHERE concept_id IN (123,234,345);"</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
New SQL commands
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>WHERE</code> - optional <code>SELECT</code> clause to limit rows</li>
<li><code>IN</code> - is field value contained in list?</li>
</ul>
</div>
</div>
</section>
<section id="sql-translation" class="level2 scrollable" data-number="10">
<h2 class="scrollable anchored" data-number="10" data-anchor-id="sql-translation"><span class="header-section-number">10</span> SQL translation</h2>
<p><code>SqlRender</code> in action:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT TOP 10 * FROM person;"</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">translate</span>(sql, <span class="at">targetDialect =</span> <span class="st">"postgresql"</span>) <span class="co"># specify the target dialect</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT  * FROM person LIMIT 10;"
attr(,"sqlDialect")
[1] "postgresql"</code></pre>
</div>
</div>
<p><br></p>
<p><code>SqlRender</code> translates most SQL functions</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Function</th>
<th style="text-align: left;">Function</th>
<th style="text-align: left;">Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ABS</td>
<td style="text-align: left;">EXP</td>
<td style="text-align: left;">RAND</td>
</tr>
<tr class="even">
<td style="text-align: left;">ACOS</td>
<td style="text-align: left;">FLOOR</td>
<td style="text-align: left;">RANK</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ASIN</td>
<td style="text-align: left;">GETDATE</td>
<td style="text-align: left;">RIGHT</td>
</tr>
<tr class="even">
<td style="text-align: left;">ATAN</td>
<td style="text-align: left;">HASHBYTES*</td>
<td style="text-align: left;">ROUND</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AVG</td>
<td style="text-align: left;">ISNULL</td>
<td style="text-align: left;">ROW_NUMBER</td>
</tr>
<tr class="even">
<td style="text-align: left;">CAST</td>
<td style="text-align: left;">ISNUMERIC</td>
<td style="text-align: left;">RTRIM</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CEILING</td>
<td style="text-align: left;">LEFT</td>
<td style="text-align: left;">SIN</td>
</tr>
<tr class="even">
<td style="text-align: left;">CHARINDEX</td>
<td style="text-align: left;">LEN</td>
<td style="text-align: left;">SQRT</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CONCAT</td>
<td style="text-align: left;">LOG</td>
<td style="text-align: left;">SQUARE</td>
</tr>
<tr class="even">
<td style="text-align: left;">COS</td>
<td style="text-align: left;">LOG10</td>
<td style="text-align: left;">STDEV</td>
</tr>
<tr class="odd">
<td style="text-align: left;">COUNT</td>
<td style="text-align: left;">LOWER</td>
<td style="text-align: left;">SUM</td>
</tr>
<tr class="even">
<td style="text-align: left;">COUNT_BIG</td>
<td style="text-align: left;">LTRIM</td>
<td style="text-align: left;">TAN</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DATEADD</td>
<td style="text-align: left;">MAX</td>
<td style="text-align: left;">UPPER</td>
</tr>
<tr class="even">
<td style="text-align: left;">DATEDIFF</td>
<td style="text-align: left;">MIN</td>
<td style="text-align: left;">VAR</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DATEFROMPARTS</td>
<td style="text-align: left;">MONTH</td>
<td style="text-align: left;">YEAR</td>
</tr>
<tr class="even">
<td style="text-align: left;">DATETIMEFROMPARTS</td>
<td style="text-align: left;">NEWID</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">DAY</td>
<td style="text-align: left;">PI</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">EOMONTH</td>
<td style="text-align: left;">POWER</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>* Requires special privileges on Oracle. Has no equivalent on SQLite</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
New or useful SQL commands
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>TOP</code> - select only the first set of rows</li>
<li><code>DATEDIFF()</code> - compute the difference btw two dates in # of <code>DAY</code>, <code>MONTH</code> or <code>YEAR</code> intervals</li>
<li><code>AVG()</code> / <code>MIN()</code> / <code>MAX()</code> - should be obvious</li>
</ul>
</div>
</div>
</section>
<section id="conditional-sql-generation" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="conditional-sql-generation"><span class="header-section-number">11</span> Conditional SQL generation</h2>
<p>To turn blocks of code on or off based on the parameter values, <code>SqlRender</code> adds a ternary operator:</p>
<ul>
<li><code>{ Condition } ? { if true } : { if false }</code></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM cohort {@x == 1} ? {WHERE subject_id = 1};"</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql,<span class="at">x =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM cohort WHERE subject_id = 1;"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(sql,<span class="at">x =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SELECT * FROM cohort ;"</code></pre>
</div>
</div>
</section>
<section id="databases-and-schema" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="databases-and-schema"><span class="header-section-number">12</span> Databases and schema</h2>
<p>Different RDBMS handle collections of tables differently</p>
<ul>
<li><p>Some enforce a single <code>database</code> with multiple <code>schema</code></p></li>
<li><p>Others enforce multiple <code>database</code>s each with a single <code>schema</code></p></li>
</ul>
<p>Solution: concatenate <code>database</code> and <code>schema</code> into single parameter <code>@databaseSchema</code></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> @databaseSchema.person</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><strong>SQL Server</strong> - <code>databaseSchema = "cdm_data.dbo"</code></p></li>
<li><p><strong>PostgreSQL</strong> - <code>databaseSchema = "cdm_data"</code></p></li>
</ul>
</section>
<section id="simple-sql-function-example" class="level2 scrollable" data-number="13">
<h2 class="scrollable anchored" data-number="13" data-anchor-id="simple-sql-function-example"><span class="header-section-number">13</span> Simple SQL function example</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT MAX(YEAR(observation_period_end_date) -</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="st">           year_of_birth) AS max_age</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="st">FROM @cdm.person</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="st">INNER JOIN @cdm.observation_period</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="st">  ON person.person_id = observation_period.person_id;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateQuerySql</span>(<span class="at">connection =</span> connection, <span class="at">sql =</span> sql,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cdm =</span> <span class="st">"synthetic.main"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  MAX_AGE
1     111</code></pre>
</div>
</div>
<p>or</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT MAX(DATEDIFF(</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="st">          YEAR, birth_datetime, observation_period_end_date)</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="st">       ) AS max_age</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="st">FROM @cdm.person</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="st">INNER JOIN @cdm.observation_period</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="st">  ON person.person_id = observation_period.person_id;</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateQuerySql</span>(<span class="at">connection =</span> connection, <span class="at">sql =</span> sql,</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cdm =</span> <span class="st">"synthetic.main"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  MAX_AGE
1     111</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">disconnect</span>(connection)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">translate</span>(sql, <span class="at">targetDialect =</span> <span class="st">"duckdb"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SELECT MAX((EXTRACT(YEAR FROM CAST(observation_period_end_date AS DATE)) - EXTRACT(YEAR FROM CAST(birth_datetime AS DATE)))
       ) AS max_age
FROM @cdm.person
INNER JOIN @cdm.observation_period
  ON person.person_id = observation_period.person_id;</code></pre>
</div>
</div>
</section>
<section id="incidence-rate-study" class="level2 scrollable" data-number="14">
<h2 class="scrollable anchored" data-number="14" data-anchor-id="incidence-rate-study"><span class="header-section-number">14</span> Incidence rate study</h2>
<p>ACE inhibitors are the most popular treatment for essential hypertension. Hypertensive patients suffer from acute myocardial infarctions (AMI). What is rate of AMI in the first year following lisinopril treatment initiation, stratified by age and gender?</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <strong>hard</strong> way
</div>
</div>
<div class="callout-body-container callout-body">
<p>Before OHDSI standardization, every analysis in every database was separately (and often poorly) hand-coded <span class="math inline">\(\ldots\)</span> like we will do here</p>
</div>
</div>
<p>We need to define (and implement in SQL)</p>
<ul>
<li><p><strong>Exposure</strong> - first exposure to lisinopril with <span class="math inline">\(\ge\)</span> 365 days of observation prior to first exposure. NB: overly simplified for clinical use</p></li>
<li><p><strong>Outcome</strong> - any occurrence of an acute myocardial infarction diagnosis code during an inpatient or emergency room (ER) visit</p></li>
<li><p><strong>Time-at-risk</strong> - compute the incidence rate of <strong>outcome</strong> in the first year after <strong>exposure</strong></p></li>
</ul>
</section>
<section id="create-a-cohort-table" class="level2 scrollable" data-number="15">
<h2 class="scrollable anchored" data-number="15" data-anchor-id="create-a-cohort-table"><span class="header-section-number">15</span> Create a <code>COHORT</code> table</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>conn <span class="ot">&lt;-</span> <span class="fu">connect</span>(<span class="at">dbms =</span> <span class="st">"duckdb"</span>, <span class="at">server =</span> absoluteFileName)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>cdmDbSchema <span class="ot">&lt;-</span> <span class="st">"synthetic.main"</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>cohortDbSchema <span class="ot">&lt;-</span> <span class="st">"synthetic.main"</span>  <span class="co"># often somewhere else</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>cohortTable <span class="ot">&lt;-</span> <span class="st">"my_cohorts"</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="st">DROP TABLE IF EXISTS @cohort_db_schema.@cohort_table;</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="st">CREATE TABLE @cohort_db_schema.@cohort_table (</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_definition_id INT,</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_start_date DATE,</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_end_date DATE,</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="st">  subject_id BIGINT</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="st">);</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateExecuteSql</span>(conn, sql,</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_db_schema =</span> cohortDbSchema,</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_table =</span> cohortTable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="build-exposure-cohort" class="level2 scrollable" data-number="16">
<h2 class="scrollable anchored" data-number="16" data-anchor-id="build-exposure-cohort"><span class="header-section-number">16</span> Build exposure cohort</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="st">INSERT INTO @cohort_db_schema.@cohort_table (</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_definition_id,</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_start_date,</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_end_date,</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="st">  subject_id</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT 1 AS cohort_definition_id,</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_start_date,</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_end_date,</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="st">  subject_id</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="st">FROM (</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT drug_era_start_date AS cohort_start_date,</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="st">    drug_era_end_date AS cohort_end_date,</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="st">    person_id AS subject_id</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM (</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT drug_era_start_date,</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="st">      drug_era_end_date,</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="st">      person_id,</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="st">      ROW_NUMBER() OVER (</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="st">        PARTITION BY person_id</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="st">            ORDER BY drug_era_start_date</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="st">      ) order_nr</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM @cdm_db_schema.drug_era</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE drug_concept_id = 1308216 -- Lisinopril</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="st">  ) ordered_exposures</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE order_nr = 1</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a><span class="st">) first_era</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="st">INNER JOIN @cdm_db_schema.observation_period</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a><span class="st">  ON subject_id = person_id</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a><span class="st">    AND observation_period_start_date &lt; cohort_start_date</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a><span class="st">    AND observation_period_end_date &gt; cohort_start_date</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE DATEDIFF(DAY,</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a><span class="st">               observation_period_start_date,</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a><span class="st">               cohort_start_date) &gt;= 365;</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateExecuteSql</span>(conn, sql,</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_db_schema =</span> cohortDbSchema,</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_table =</span> cohortTable,</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cdm_db_schema =</span> cdmDbSchema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Take first drug exposure per person from <code>DRUG_ERA</code></li>
<li>Join to <code>OBSERVATION_PERIOD</code> during exposure and require prior observation time</li>
</ul>
</div>
</div>
</section>
<section id="build-outcome-cohort" class="level2 scrollable" data-number="17">
<h2 class="scrollable anchored" data-number="17" data-anchor-id="build-outcome-cohort"><span class="header-section-number">17</span> Build outcome cohort</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="st">INSERT INTO @cohort_db_schema.@cohort_table (</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="st"> cohort_definition_id,</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="st"> cohort_start_date,</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="st"> cohort_end_date,</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="st">subject_id</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT 2 AS cohort_definition_id,</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_start_date,</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="st">  cohort_end_date,</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="st">  subject_id</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="st">FROM (</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT DISTINCT person_id AS subject_id,</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="st">    condition_start_date AS cohort_start_date,</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="st">    condition_end_date AS cohort_end_date</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM @cdm_db_schema.condition_occurrence</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cdm_db_schema.concept_ancestor</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="st">    ON condition_concept_id = descendant_concept_id</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE ancestor_concept_id = 4329847 -- Acute MI</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="st">) distinct_occurrence</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="st">INNER JOIN @cdm_db_schema.visit_occurrence</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="st">  ON subject_id = person_id</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="st">  AND visit_start_date &lt;= cohort_start_date</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="st">  AND visit_end_date &gt;= cohort_start_date</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE visit_concept_id IN (262, 9203,</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="st">    9201) -- Inpatient or ER;</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="fu">renderTranslateExecuteSql</span>(conn, sql,</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_db_schema =</span> cohortDbSchema,</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cohort_table =</span> cohortTable,</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>                          <span class="at">cdm_db_schema =</span> cdmDbSchema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Join <code>CONDITION_OCCURRENCE</code> to <code>CONCEPT_ANCESTOR</code> to find all occurrences of AMI or any of its descendents (more later)</li>
<li>Use <code>DISTINCT</code> to select at most one record per day</li>
<li>Join <code>VISIT_OCCURENCE</code> to ensure diagnosis was in-patient or ER</li>
</ul>
</div>
</div>
</section>
<section id="calculate-incidence-rate" class="level2 scrollable" data-number="18">
<h2 class="scrollable anchored" data-number="18" data-anchor-id="calculate-incidence-rate"><span class="header-section-number">18</span> Calculate incidence rate</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="st">WITH tar AS (</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT concept_name AS gender,</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="st">    FLOOR((YEAR(cohort_start_date) -</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="st">          year_of_birth) / 10) AS age,</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="st">    subject_id,</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="st">    cohort_start_date,</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="st">    CASE WHEN DATEADD(DAY, 365, cohort_start_date) &gt;</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="st">      observation_period_end_date</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="st">    THEN observation_period_end_date</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="st">    ELSE DATEADD(DAY, 365, cohort_start_date)</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="st">    END AS cohort_end_date</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM @cohort_db_schema.@cohort_table</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cdm_db_schema.observation_period</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="st">    ON subject_id = observation_period.person_id</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="st">      AND observation_period_start_date &lt; cohort_start_date</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="st">      AND observation_period_end_date &gt; cohort_start_date</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cdm_db_schema.person</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="st">    ON subject_id = person.person_id</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cdm_db_schema.concept</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="st">    ON gender_concept_id = concept_id</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE cohort_definition_id = 1 -- Exposure</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT days.gender,</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="st">    days.age,</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="st">    days,</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="st">    CASE WHEN events IS NULL THEN 0 ELSE events END AS events</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="st">FROM (</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT gender,</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a><span class="st">    age,</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="st">    SUM(DATEDIFF(DAY, cohort_start_date,</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="st">      cohort_end_date)) AS days</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM tar</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY gender,</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a><span class="st">    age</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="st">) days</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN (</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT gender,</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="st">      age,</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a><span class="st">      COUNT(*) AS events</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM tar</span></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a><span class="st">  INNER JOIN @cohort_db_schema.@cohort_table ami</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="st">    ON tar.subject_id = ami.subject_id</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="st">      AND tar.cohort_start_date &lt;= ami.cohort_start_date</span></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a><span class="st">      AND tar.cohort_end_date &gt;= ami.cohort_start_date</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE cohort_definition_id = 2 -- Outcome</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY gender,</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a><span class="st">    age</span></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a><span class="st">) events</span></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a><span class="st">ON days.gender = events.gender</span></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a><span class="st">  AND days.age = events.age;</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">renderTranslateQuerySql</span>(conn, sql,</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cohort_db_schema =</span> cohortDbSchema,</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cohort_table =</span> cohortTable,</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cdm_db_schema =</span> cdmDbSchema,</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">snakeCaseToCamelCase =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a><span class="fu">disconnect</span>(conn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="examine-results" class="level2 scrollable" data-number="19">
<h2 class="scrollable anchored" data-number="19" data-anchor-id="examine-results"><span class="header-section-number">19</span> Examine results</h2>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute incidence rate (IR)</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>ir <span class="ot">&lt;-</span>  results<span class="sc">$</span>events <span class="sc">/</span> (results<span class="sc">$</span>days <span class="sc">/</span> <span class="fl">365.25</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix age scale</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>age <span class="ot">&lt;-</span> results<span class="sc">$</span>age <span class="sc">*</span> <span class="dv">10</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> ir, <span class="at">group =</span> gender, <span class="at">color =</span> gender)) <span class="sc">+</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Age"</span>) <span class="sc">+</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Incidence (per patient year)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell quarto-layout-panel" data-layout="[200]" data-layout-align="center">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_sql_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:9in"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="final-words" class="level2" data-number="20">
<h2 data-number="20" class="anchored" data-anchor-id="final-words"><span class="header-section-number">20</span> Final words</h2>
<p>One study, one database, one (almost unusable) script <span class="math inline">\(\ldots\)</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/current_approach_one_study_one_script.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
You do <strong>not</strong> want to do things this way!
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>